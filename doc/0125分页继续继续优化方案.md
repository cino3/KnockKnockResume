# ç®€å†åˆ†é¡µç®—æ³•ç°çŠ¶ä¸ä¼˜åŒ–æ–¹æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**æœ€åæ›´æ–°ï¼š** 2026-01-25
**å½“å‰çŠ¶æ€ï¼š** æ–¹æ¡ˆBï¼ˆåŠ¨æ€å®¹å·®èŒƒå›´ï¼‰å·²å®æ–½ï¼Œæ•ˆæœè‰¯å¥½

---

## ğŸ“Š ä¸€ã€å½“å‰åˆ†é¡µæ–¹æ¡ˆè¯¦è§£

### 1.1 æ ¸å¿ƒåŸç†

**åˆ†é¡µç­–ç•¥ï¼š** åŸºäº `safetyBuffer`ï¼ˆå®‰å…¨ç¼“å†²åŒºï¼‰çš„åŸå­çº§åˆ†é¡µç®—æ³•

```
å°†ç®€å†å†…å®¹æ‹†åˆ†æˆæœ€å°"åŸå­"å•ä½ â†’ é€ä¸ªæµ‹é‡é«˜åº¦ â†’ ç´¯åŠ åˆ¤æ–­æ˜¯å¦è¶…è¿‡é¡µé¢é«˜åº¦ â†’ è¶…è¿‡åˆ™æ¢é¡µ
```

**å…³é”®ä»£ç ä½ç½®ï¼š** `src/components/Preview.vue:123-197`

---

### 1.2 å…³é”®å¸¸é‡å®šä¹‰

| å¸¸é‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| `A4_HEIGHT_PX` | 1123px | A4çº¸é«˜åº¦ï¼ˆ96 DPIï¼‰ |
| `PAGE_PADDING_Y` | 93px | ä¸Šä¸‹è¾¹è·ä¹‹å’Œï¼ˆ36px + 57pxï¼‰ |
| `MAX_CONTENT_HEIGHT` | 1030px | å®é™…å¯ç”¨é«˜åº¦ = 1123 - 93 |
| `OVERFLOW_THRESHOLD` | 2px | å…è®¸å†…å®¹æº¢å‡º2pxçš„å®¹å·® |
| `TARGET_MARGIN` | 12px | **ç¬¬1é¡µç›®æ ‡ç•™ç™½** |
| `MARGIN_TOLERANCE` | 8px | **ç¬¬1é¡µå®¹å·®Â±8px**ï¼ˆèŒƒå›´4-20pxï¼‰ |

**ä»£ç ä½ç½®ï¼š** `src/components/Preview.vue:64-69`

---

### 1.3 æ ¸å¿ƒç®—æ³•æµç¨‹

#### **Step 1: å†…å®¹åŸå­åŒ–æ‹†åˆ†**

```javascript
// å°†ç®€å†æ‹†åˆ†æˆä¸å¯å†åˆ†çš„æœ€å°å•å…ƒ
const atoms = [
  'item-header',  // æ¯ä¸ªå·¥ä½œç»å†çš„æ ‡é¢˜å—
  'text-line'     // æ¯ä¸€è¡Œæ–‡å­—
]
```

**ç¤ºä¾‹ï¼š**
```
âŒ ä¸æ˜¯ï¼š[æ•´ä¸ª"å·¥ä½œç»å†"æ¿å—]
âœ… è€Œæ˜¯ï¼š[å…¬å¸Aæ ‡é¢˜è¡Œ] [èŒä½è¡Œ] [æè¿°è¡Œ1] [æè¿°è¡Œ2] ...
```

---

#### **Step 2: é«˜åº¦è®¡ç®—ï¼ˆå¸¦safetyBufferï¼‰**

```javascript
function getOuterHeight(el, safetyBuffer) {
  const style = window.getComputedStyle(el)
  const marginTop = parseFloat(style.marginTop || '0')
  const marginBottom = parseFloat(style.marginBottom || '0')
  // è®¡ç®— = å…ƒç´ é«˜åº¦ + ä¸Šè¾¹è· + ä¸‹è¾¹è· + safetyBuffer
  return el.offsetHeight + marginTop + marginBottom + safetyBuffer
}
```

**safetyBuffer çš„ä½œç”¨ï¼š**
- **æ­£å€¼ï¼ˆå¦‚+5pxï¼‰ï¼š** æ¯ä¸ª"åŸå­"å¤šç®—5px â†’ æå‰è§¦å‘åˆ†é¡µ â†’ é¡µé¢ç•™ç™½å¢å¤§
- **0ï¼š** æŒ‰çœŸå®æµ‹é‡ç®— â†’ æœ€ç²¾ç¡® â†’ æœ€æ¿€è¿›å¡«å……
- **è´Ÿå€¼ï¼ˆå¦‚-5pxï¼‰ï¼š** æ¯ä¸ª"åŸå­"å°‘ç®—5px â†’ å»¶ååˆ†é¡µ â†’ å¯èƒ½æº¢å‡º

---

#### **Step 3: é€ä¸ªè£…ç®±åˆ†é¡µ**

```javascript
for (const atom of atoms) {
  const atomHeight = getOuterHeight(atom, safetyBuffer)

  // åˆ¤æ–­ï¼šå½“å‰é¡µæ˜¯å¦è¿˜èƒ½è£…ä¸‹è¿™ä¸ªåŸå­ï¼Ÿ
  if (!shouldFitInPage(currentHeight, atomHeight)) {
    startNewPage()  // æ¢æ–°é¡µ
  }

  currentPageNodes.push(atom)
  currentHeight += atomHeight
}
```

---

#### **Step 4: æ–¹æ¡ˆB - åŠ¨æ€å®¹å·®ç­–ç•¥ï¼ˆå·²å®æ–½ï¼‰**

**ä»£ç ä½ç½®ï¼š** `src/components/Preview.vue:200-306`

**ä¸‰æ­¥æµç¨‹ï¼š**

```javascript
// ç¬¬1æ­¥ï¼šåˆæµ‹ (safetyBuffer=0)
const initialTest = calculateWithBuffer(sourceRoot, 0)
const initialMargins = initialTest.heights.map(h => MAX_CONTENT_HEIGHT - h)

// ç¬¬2æ­¥ï¼šæ ¹æ®ç¬¬2é¡µç•™ç™½åŠ¨æ€è°ƒæ•´ç­–ç•¥
if (initialMargins.length > 1 && initialMargins[1] > 150) {
  // å®½æ¾ç­–ç•¥ï¼šç¬¬1é¡µå…è®¸45pxÂ±15pxï¼ˆèŒƒå›´30-60pxï¼‰
  dynamicTarget = 45
  dynamicTolerance = 15
} else {
  // æ ‡å‡†ç­–ç•¥ï¼šç¬¬1é¡µå…è®¸12pxÂ±8pxï¼ˆèŒƒå›´4-20pxï¼‰
  dynamicTarget = 12
  dynamicTolerance = 8
}

// ç¬¬3æ­¥ï¼šç”¨åŠ¨æ€å®¹å·®é‡æ–°è¯„ä¼°æ‰€æœ‰safetyBufferå€¼
for (const safetyBuffer of testBuffers) {
  const { pages, heights } = calculateWithBuffer(sourceRoot, safetyBuffer)
  // ä½¿ç”¨åŠ¨æ€å®¹å·®è¯„åˆ†
  const score = calculateScore(heights, dynamicTarget, dynamicTolerance)
  // é€‰æ‹©å¾—åˆ†æœ€ä½çš„æ–¹æ¡ˆ
}
```

**è¯„åˆ†é€»è¾‘ï¼š**
```javascript
for (let i = 0; i < pageHeights.length; i++) {
  const margin = MAX_CONTENT_HEIGHT - pageHeights[i]

  if (margin < 0) {
    score = Infinity  // æº¢å‡ºï¼Œç›´æ¥è·³è¿‡
  } else if (i === 0) {
    // ç¬¬1é¡µï¼šä½¿ç”¨åŠ¨æ€å®¹å·®
    if (marginåœ¨åŠ¨æ€èŒƒå›´å†…) {
      score -= 10  // å¥–åŠ±
    } else {
      score += åå·® * 2  // æƒ©ç½šï¼ˆæƒé‡2å€ï¼‰
    }
  } else {
    // å…¶ä»–é¡µï¼šç•™ç™½è¶Šå¤§ï¼Œæƒ©ç½šè¶Šå¤§
    score += margin
  }
}
```

---

### 1.4 å½“å‰æ•ˆæœå®æµ‹

**æµ‹è¯•åœºæ™¯ï¼š** ç®€å†å†…å®¹çº¦2é¡µ

| æ–¹æ¡ˆ | ç¬¬1é¡µç•™ç™½ | ç¬¬2é¡µç•™ç™½ | çŠ¶æ€ |
|------|-----------|-----------|------|
| **ä¼˜åŒ–å‰ï¼ˆå›ºå®šç­–ç•¥ï¼‰** | 8px | 363px | âš ï¸ ç¬¬2é¡µç•™ç™½è¿‡å¤§ |
| **ä¼˜åŒ–åï¼ˆæ–¹æ¡ˆBï¼‰** | 59px âœ… | 312px | âœ… å¹³è¡¡æ”¹å–„ |

**æ”¹å–„å¹…åº¦ï¼š**
- ç¬¬1é¡µç•™ç™½ï¼š8px â†’ 59pxï¼ˆ+51pxï¼Œè¾¾æ ‡ï¼‰
- ç¬¬2é¡µç•™ç™½ï¼š363px â†’ 312pxï¼ˆ-51pxï¼Œæ”¹å–„14%ï¼‰
- è§¦å‘ç­–ç•¥ï¼šå®½æ¾ï¼ˆç¬¬2é¡µ363px > 150pxé˜ˆå€¼ï¼‰

---

## ğŸ”’ äºŒã€é™åˆ¶ç‚¹ä¸å¡ç‚¹åˆ†æ

### 2.1 æ ¸å¿ƒé™åˆ¶ï¼šå…¨å±€safetyBuffer

**é—®é¢˜æè¿°ï¼š**

```
safetyBuffer æ˜¯å…¨å±€å‚æ•°ï¼ŒåŒæ—¶å½±å“æ‰€æœ‰é¡µé¢
â†’ æ— æ³•è®©ç¬¬1é¡µå’Œç¬¬2é¡µåŒæ—¶è¾¾åˆ°æœ€ä¼˜
â†’ åªèƒ½æƒè¡¡å–èˆ
```

**å…·ä½“è¡¨ç°ï¼š**

```
safetyBuffer = 0:
  â”œâ”€ ç¬¬1é¡µ: 8px âœ…ï¼ˆåœ¨4-20pxèŒƒå›´å†…ï¼Œå®Œç¾ï¼‰
  â””â”€ ç¬¬2é¡µ: 363px âš ï¸ï¼ˆç•™ç™½è¿‡å¤§ï¼‰

safetyBuffer = 0.5:
  â”œâ”€ ç¬¬1é¡µ: 59px âœ…ï¼ˆåœ¨30-60pxèŒƒå›´å†…ï¼Œè¾¾æ ‡ï¼‰
  â””â”€ ç¬¬2é¡µ: 312px âš ï¸ï¼ˆä»æœ‰ç•™ç™½ï¼Œä½†æ”¹å–„ï¼‰

safetyBuffer = 1:
  â”œâ”€ ç¬¬1é¡µ: 59px âœ…
  â””â”€ ç¬¬2é¡µ: 312px âš ï¸ï¼ˆä¸0.5æ•ˆæœç›¸åŒï¼‰
```

**æ ¹æœ¬åŸå› ï¼š**
- safetyBufferåªèƒ½è®©å†…å®¹"æ•´ä½“å‰ç§»"æˆ–"æ•´ä½“åç§»"
- æ— æ³•é’ˆå¯¹æŸä¸€é¡µå•ç‹¬è°ƒæ•´
- è¿™æ˜¯ç®—æ³•è®¾è®¡çš„ç»“æ„æ€§é™åˆ¶

---

### 2.2 æ¬¡è¦é™åˆ¶ï¼šè¯„åˆ†æƒé‡éš¾ä»¥å¹³è¡¡

**å½“å‰æƒé‡è®¾è®¡ï¼š**
- ç¬¬1é¡µåå·®ï¼šæƒé‡ **2å€**
- å…¶ä»–é¡µç•™ç™½ï¼šæƒé‡ **1å€**

**é—®é¢˜ï¼š**
```javascript
// åœºæ™¯ï¼šç¬¬1é¡µ8px vs ç¬¬2é¡µ363px
// å¦‚æœé™ä½ç¬¬1é¡µæƒé‡ï¼Œå¯èƒ½å¯¼è‡´ç¬¬1é¡µç•™ç™½è¿‡å°
// å¦‚æœæé«˜ç¬¬1é¡µæƒé‡ï¼Œå¯èƒ½å¯¼è‡´ç¬¬2é¡µç•™ç™½è¿‡å¤§
```

**è°ƒå‚å›°å¢ƒï¼š**
- æƒé‡2â†’1.5ï¼šç¬¬2é¡µå¯èƒ½æ”¹å–„ï¼Œä½†ç¬¬1é¡µå¯èƒ½å˜å·®
- æƒé‡2â†’2.5ï¼šç¬¬1é¡µæ›´å¥½ï¼Œä½†ç¬¬2é¡µå¯èƒ½æ›´å·®

---

### 2.3 æŠ€æœ¯å¡ç‚¹ï¼šé«˜åº¦æµ‹é‡è¯¯å·®

**é—®é¢˜ï¼š** æµ‹é‡é«˜åº¦ â‰  å®é™…æ¸²æŸ“é«˜åº¦

**åŸå› ï¼š**
1. **MarginæŠ˜å ï¼ˆMargin Collapsingï¼‰**
   ```javascript
   // æµ‹é‡æ—¶ï¼šmarginTop + marginBottom ç›¸åŠ 
   // å®é™…æ¸²æŸ“ï¼šç›¸é‚»å…ƒç´ çš„marginä¼šæŠ˜å ï¼Œå–è¾ƒå¤§å€¼
   ```

2. **Sub-pixelæ¸²æŸ“**
   ```
   æµè§ˆå™¨åœ¨æ¸²æŸ“æ—¶ä¼šè¿›è¡Œåƒç´ èˆå…¥
   æµ‹é‡çš„22.4pxå¯èƒ½å®é™…æ¸²æŸ“ä¸º22px
   ```

3. **Flexå¸ƒå±€çš„å¾®å°å·®å¼‚**
   ```
   justify-content: space-between
   å®é™…é—´è·å¯èƒ½ä¸æµ‹é‡ç•¥æœ‰åå·®
   ```

**å½±å“ï¼š**
- safetyBuffer = 0æ—¶ï¼Œç†è®ºä¸Šç²¾ç¡®ï¼Œä½†ä»æœ‰2-3pxè¯¯å·®
- è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆéœ€è¦ `OVERFLOW_THRESHOLD = 2px`

---

### 2.4 æ€§èƒ½å¡ç‚¹ï¼šæš´åŠ›æœç´¢æ•ˆç‡ä½

**å½“å‰å®ç°ï¼š**
```javascript
const testBuffers = [
  0, -0.5, -1, -1.5, -2, -2.5, -3,
  0.5, 1, 1.5, 2, 3, 5,
  -5, -10, -15, 10, 15
]  // å…±17ä¸ªå€¼
```

**æ—¶é—´å¤æ‚åº¦ï¼š**
- æ¯æ¬¡å†…å®¹æ›´æ–°ï¼šæµ‹è¯•17æ¬¡
- æ¯æ¬¡æµ‹è¯•ï¼šéå†æ‰€æœ‰å†…å®¹å…ƒç´ 
- æ€»å¤æ‚åº¦ï¼šO(17 Ã— n)ï¼Œnä¸ºå…ƒç´ æ•°é‡

**å®é™…å½±å“ï¼š**
- å°ç®€å†ï¼ˆ<50é¡¹ï¼‰ï¼šæ„Ÿè§‰ä¸åˆ°å»¶è¿Ÿ
- å¤§ç®€å†ï¼ˆ>100é¡¹ï¼‰ï¼šå¯èƒ½æœ‰è½»å¾®å¡é¡¿

---

### 2.5 ç”¨æˆ·ä½“éªŒå¡ç‚¹ï¼šæœ€åä¸€é¡µç•™ç™½æå¤§

**ç°è±¡ï¼š**
```
ç¬¬1é¡µ: 59px âœ…
ç¬¬2é¡µ: 312px âš ï¸
ç¬¬3é¡µ: 805px âŒâŒâŒï¼ˆå¦‚æœåªæœ‰3é¡µï¼Œæœ€åä¸€é¡µå¾€å¾€å¾ˆç©ºï¼‰
```

**åŸå› ï¼š**
- å†…å®¹åˆšå¥½åœ¨ç¬¬2é¡µæœ«å°¾ç»“æŸ
- ç¬¬3é¡µåªæœ‰å°‘é‡å†…å®¹ï¼ˆå¦‚"ä¸“ä¸šæŠ€èƒ½"æ¿å—ï¼‰
- æ— æ³•é¿å…

---

## ğŸš€ ä¸‰ã€è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå¤šçº§å®½æ¾ç­–ç•¥ï¼ˆå¿«é€Ÿæ”¹è¿›â­ï¼‰

**éš¾åº¦ï¼š** â­ ç®€å•
**æ—¶é—´ï¼š** 5åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­â­

**åŸç†ï¼š** åœ¨å½“å‰æ–¹æ¡ˆBåŸºç¡€ä¸Šï¼Œå¢åŠ æ›´å¤šç­–ç•¥å±‚çº§

**å®ç°ï¼š**
```javascript
if (ç¬¬2é¡µç•™ç™½ > 300px) {
  // æåº¦å®½æ¾ï¼šç¬¬1é¡µå…è®¸60-100px
  dynamicTarget = 80
  dynamicTolerance = 20
} else if (ç¬¬2é¡µç•™ç™½ > 150px) {
  // å®½æ¾ï¼šç¬¬1é¡µå…è®¸30-60pxï¼ˆå½“å‰æ–¹æ¡ˆBï¼‰
  dynamicTarget = 45
  dynamicTolerance = 15
} else if (ç¬¬2é¡µç•™ç™½ > 100px) {
  // é€‚ä¸­ï¼šç¬¬1é¡µå…è®¸20-40px
  dynamicTarget = 30
  dynamicTolerance = 10
} else {
  // æ ‡å‡†ï¼šç¬¬1é¡µå…è®¸4-20px
  dynamicTarget = 12
  dynamicTolerance = 8
}
```

**é¢„æœŸæ•ˆæœï¼š**
- ç¬¬2é¡µ363px â†’ è§¦å‘"æåº¦å®½æ¾"
- ç¬¬1é¡µï¼š59px â†’ çº¦75px
- ç¬¬2é¡µï¼š312px â†’ çº¦280px

**ä¼˜ç‚¹ï¼š**
- å®ç°ç®€å•ï¼Œåªéœ€ä¿®æ”¹å‡ è¡Œä»£ç 
- ç«‹å³è§æ•ˆ
- é£é™©ä½

**ç¼ºç‚¹ï¼š**
- ç¬¬1é¡µç•™ç™½å¯èƒ½åå¤§ï¼ˆ75pxï¼‰
- æ²»æ ‡ä¸æ²»æœ¬

---

### æ–¹æ¡ˆ2ï¼šå‹ç¼©è¡Œé«˜ï¼ˆæ¨èâ­â­â­â­ï¼‰

**éš¾åº¦ï¼š** â­â­â­ ä¸­ç­‰
**æ—¶é—´ï¼š** 20åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­â­â­

**åŸç†ï¼š** å½“æŸé¡µç•™ç™½è¿‡å¤§æ—¶ï¼Œè½»å¾®å‹ç¼©è¯¥é¡µçš„è¡Œé«˜

**å®ç°ï¼š**
```javascript
function compressLineHeight(pageItems, targetReduction) {
  const currentLineHeight = parseFloat(store.theme.lineHeight) || 1.6

  // å°è¯•é™ä½è¡Œé«˜ï¼Œæœ€å°1.4ï¼ˆå¯è¯»æ€§åº•çº¿ï¼‰
  const newLineHeight = Math.max(1.4, currentLineHeight - 0.1)

  // ä¼°ç®—èƒ½èŠ‚çœå¤šå°‘ç©ºé—´
  const estimatedSavings = estimateSavings(pageItems, currentLineHeight, newLineHeight)

  if (estimatedSavings >= targetReduction) {
    // åº”ç”¨æ–°çš„è¡Œé«˜åˆ°å½“å‰é¡µ
    applyLineHeightToPage(pageItems, newLineHeight)
    return estimatedSavings
  }

  return 0
}

// åœ¨åˆ†é¡µåè°ƒç”¨
for (let i = 1; i < pages.length; i++) {
  const margin = MAX_CONTENT_HEIGHT - pageHeights[i]

  if (margin > 300) {
    // å°è¯•å‹ç¼©åˆ°1.5
    const saved = compressLineHeight(pages[i], margin - 200)
    console.log(`ç¬¬${i+1}é¡µå‹ç¼©è¡Œé«˜ï¼ŒèŠ‚çœ${saved}px`)
  }
}
```

**é¢„æœŸæ•ˆæœï¼š**
- è¡Œé«˜1.6 â†’ 1.55ï¼ˆå‡ ä¹çœ‹ä¸å‡ºï¼‰
- æ¯é¡µçº¦èŠ‚çœ5-8%ç©ºé—´
- ç¬¬2é¡µ312px â†’ çº¦260px

**ä¼˜ç‚¹ï¼š**
- è§†è§‰å½±å“å°ï¼ˆ1.6â†’1.55å¾ˆéš¾å¯Ÿè§‰ï¼‰
- èƒ½æœ‰æ•ˆå‡å°‘ç•™ç™½
- å¯ç²¾ç¡®æ§åˆ¶

**ç¼ºç‚¹ï¼š**
- éœ€è¦ä¿®æ”¹DOMæ ·å¼
- å¯èƒ½å½±å“å¯è¯»æ€§ï¼ˆå¦‚æœå‹ç¼©è¿‡åº¦ï¼‰

---

### æ–¹æ¡ˆ3ï¼šé€é¡µç‹¬ç«‹ä¼˜åŒ–ï¼ˆæœ€å½»åº•â­â­â­â­â­ï¼‰

**éš¾åº¦ï¼š** â­â­â­â­ è¾ƒéš¾
**æ—¶é—´ï¼š** 30åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­â­â­â­

**åŸç†ï¼š** æ‰“ç ´å…¨å±€safetyBufferé™åˆ¶ï¼Œæ¯é¡µä½¿ç”¨ç‹¬ç«‹çš„safetyBuffer

**å®ç°ï¼š**
```javascript
function calculatePagesIndependently() {
  // ç¬¬1æ­¥ï¼šç²—åˆ†é¡µï¼ˆsafetyBuffer=0ï¼‰
  let { pages, heights } = calculateWithBuffer(sourceRoot, 0)

  // ç¬¬2æ­¥ï¼šé€é¡µä¼˜åŒ–
  for (let i = 0; i < pages.length - 1; i++) {
    const margin = MAX_CONTENT_HEIGHT - heights[i]

    if (margin > 100) {
      // å°è¯•ä»ä¸‹ä¸€é¡µ"å·"ä¸€ä¸ªå…ƒç´ 
      const nextPageFirstItem = pages[i + 1][0]
      const itemHeight = getOuterHeight(nextPageFirstItem, 0)

      if (margin >= itemHeight) {
        // ç§»åŠ¨å…ƒç´ åˆ°å½“å‰é¡µ
        pages[i].push(nextPageFirstItem)
        pages[i + 1].shift()

        // é‡æ–°æµ‹é‡å½“å‰é¡µå®é™…é«˜åº¦
        heights[i] = measureActualHeight(pages[i])
        console.log(`ç¬¬${i+1}é¡µä»ç¬¬${i+2}é¡µå·äº†ä¸€ä¸ªå…ƒç´ `)
      }
    }
  }

  return pages
}

function measureActualHeight(pageNodes) {
  // åˆ›å»ºä¸´æ—¶å®¹å™¨ï¼Œå®é™…æ¸²æŸ“åæµ‹é‡
  const tempContainer = document.createElement('div')
  tempContainer.style.width = '794px'
  tempContainer.style.padding = '36px 47px 57px 47px'
  tempContainer.style.visibility = 'hidden'

  pageNodes.forEach(node => tempContainer.appendChild(node.cloneNode(true)))
  document.body.appendChild(tempContainer)

  const actualHeight = tempContainer.offsetHeight
  document.body.removeChild(tempContainer)

  return actualHeight
}
```

**é¢„æœŸæ•ˆæœï¼š**
- ç¬¬1é¡µï¼šç”¨safetyBuffer=0ï¼Œç•™ç™½8px
- ç¬¬2é¡µï¼šä»ç¬¬3é¡µå·ä¸€ä¸ªå…ƒç´ ï¼Œç•™ç™½å‡å°‘åˆ°200pxå·¦å³
- æ¯é¡µéƒ½å°½å¯èƒ½å¡«æ»¡

**ä¼˜ç‚¹ï¼š**
- æœ€å½»åº•çš„è§£å†³æ–¹æ¡ˆ
- æ‰“ç ´å…¨å±€safetyBufferé™åˆ¶
- æ¯é¡µéƒ½èƒ½è¾¾åˆ°æœ€ä¼˜

**ç¼ºç‚¹ï¼š**
- å®ç°å¤æ‚åº¦é«˜
- éœ€è¦å®é™…DOMæµ‹é‡
- å¯èƒ½ç ´åå†…å®¹è¯­ä¹‰ï¼ˆå¦‚æŠŠæ ‡é¢˜å’Œå†…å®¹åˆ†å¼€ï¼‰

---

### æ–¹æ¡ˆ4ï¼šäºŒåˆ†æœç´¢ä¼˜åŒ–ï¼ˆæ€§èƒ½æå‡â­â­â­ï¼‰

**éš¾åº¦ï¼š** â­â­ ä¸­ç­‰
**æ—¶é—´ï¼š** 10åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­ï¼ˆä»…æ€§èƒ½ï¼‰

**åŸç†ï¼š** ç”¨äºŒåˆ†æœç´¢ä»£æ›¿æš´åŠ›æµ‹è¯•17ä¸ªå€¼

**å®ç°ï¼š**
```javascript
function findOptimalBufferBinary(sourceRoot, dynamicTarget, dynamicTolerance) {
  let left = -15
  let right = 15
  let bestScore = Infinity
  let bestBuffer = 0

  // é»„é‡‘åˆ†å‰²æœç´¢ï¼Œè¿­ä»£10æ¬¡
  for (let i = 0; i < 10; i++) {
    const mid1 = left + (right - left) / 3
    const mid2 = right - (right - left) / 3

    const score1 = evaluateBuffer(sourceRoot, mid1, dynamicTarget, dynamicTolerance)
    const score2 = evaluateBuffer(sourceRoot, mid2, dynamicTarget, dynamicTolerance)

    if (score1 < score2) {
      right = mid2
      if (score1 < bestScore) {
        bestScore = score1
        bestBuffer = mid1
      }
    } else {
      left = mid1
      if (score2 < bestScore) {
        bestScore = score2
        bestBuffer = mid2
      }
    }
  }

  return bestBuffer
}
```

**æ€§èƒ½å¯¹æ¯”ï¼š**
- å½“å‰ï¼šæµ‹è¯•17æ¬¡ï¼ŒO(17n)
- ä¼˜åŒ–åï¼šæµ‹è¯•10æ¬¡ï¼ŒO(10n)
- æå‡ï¼šçº¦40%

**ä¼˜ç‚¹ï¼š**
- æ€§èƒ½æå‡æ˜æ˜¾
- ä¸éœ€è¦ç¡¬ç¼–ç æµ‹è¯•å€¼
- è‡ªåŠ¨æ‰¾åˆ°æœ€ä¼˜è§£

**ç¼ºç‚¹ï¼š**
- ä¸æ”¹å–„åˆ†é¡µè´¨é‡ï¼ˆåªæå‡é€Ÿåº¦ï¼‰
- å¯¹äºå°ç®€å†ï¼Œæ€§èƒ½æå‡ä¸æ˜æ˜¾

---

### æ–¹æ¡ˆ5ï¼šç”¨æˆ·å¯é€‰ç­–ç•¥ï¼ˆæœ€çµæ´»â­â­â­ï¼‰

**éš¾åº¦ï¼š** â­â­ ä¸­ç­‰
**æ—¶é—´ï¼š** 15åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­â­

**åŸç†ï¼š** æä¾›å¤šç§åˆ†é¡µæ¨¡å¼ä¾›ç”¨æˆ·é€‰æ‹©

**å®ç°ï¼š**
```javascript
const PAGINATION_PRESETS = {
  'balanced': {
    name: 'å¹³è¡¡æ¨¡å¼',
    description: 'ç¬¬1é¡µå’Œç¬¬2é¡µç•™ç™½å‡è¡¡',
    firstPageTarget: 45,
    firstPageTolerance: 15
  },
  'first-priority': {
    name: 'ç¬¬1é¡µä¼˜å…ˆ',
    description: 'ä¼˜å…ˆä¿è¯ç¬¬1é¡µç¾è§‚',
    firstPageTarget: 12,
    firstPageTolerance: 8
  },
  'fill-all': {
    name: 'å¡«æ»¡æ¨¡å¼',
    description: 'å°½é‡å‡å°‘æ‰€æœ‰é¡µé¢çš„ç•™ç™½',
    firstPageTarget: 60,
    firstPageTolerance: 20
  },
  'compact': {
    name: 'ç´§å‡‘æ¨¡å¼',
    description: 'æœ€å°åŒ–æ€»é¡µæ•°',
    firstPageTarget: 80,
    firstPageTolerance: 30
  }
}

// åœ¨UIä¸­æ·»åŠ ä¸‹æ‹‰èœå•
// ç”¨æˆ·é€‰æ‹©åï¼ŒåŠ¨æ€åº”ç”¨å‚æ•°
```

**ä¼˜ç‚¹ï¼š**
- ç”¨æˆ·å¯è‡ªä¸»é€‰æ‹©åå¥½
- çµæ´»æ€§æœ€é«˜
- å®ç°ç®€å•

**ç¼ºç‚¹ï¼š**
- å¢åŠ ç•Œé¢å¤æ‚åº¦
- éœ€è¦ç”¨æˆ·ç†è§£ä¸åŒç­–ç•¥çš„å«ä¹‰

---

### æ–¹æ¡ˆ6ï¼šæ™ºèƒ½å…ƒç´ è¿ç§»ï¼ˆé«˜çº§â­â­â­â­ï¼‰

**éš¾åº¦ï¼š** â­â­â­â­ è¾ƒéš¾
**æ—¶é—´ï¼š** 40åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­â­â­

**åŸç†ï¼š** å½“æ£€æµ‹åˆ°æŸé¡µç•™ç™½è¿‡å¤§æ—¶ï¼Œå°è¯•ä»å…¶ä»–é¡µè¿ç§»å°å…ƒç´ 

**å®ç°ï¼š**
```javascript
function optimizeByMigration(pages) {
  for (let i = 0; i < pages.length - 1; i++) {
    const margin = MAX_CONTENT_HEIGHT - measureActualHeight(pages[i])

    if (margin > 200) {
      // å°è¯•ä»ä¸‹ä¸€é¡µæ‰¾ä¸€ä¸ªèƒ½æ”¾å¾—ä¸‹çš„å°å…ƒç´ 
      const candidates = findSmallItems(pages[i + 1], margin)

      for (const candidate of candidates) {
        if (candidate.height <= margin) {
          // è¿ç§»å…ƒç´ 
          migrateItem(pages[i + 1], pages[i], candidate)
          console.log(`è¿ç§»å…ƒç´ åˆ°ç¬¬${i+1}é¡µ`)
          break
        }
      }
    }
  }
}

function findSmallItems(pageNodes, maxHeight) {
  // æ‰¾å‡ºæ‰€æœ‰é«˜åº¦å°äºmaxHeightçš„å…ƒç´ 
  const items = []
  for (const section of pageNodes) {
    for (const item of section.children) {
      const height = getOuterHeight(item, 0)
      if (height <= maxHeight) {
        items.push({ element: item, height: height })
      }
    }
  }
  // æŒ‰é«˜åº¦æ’åºï¼Œä¼˜å…ˆè¿ç§»å¤§å…ƒç´ 
  return items.sort((a, b) => b.height - a.height)
}
```

**é¢„æœŸæ•ˆæœï¼š**
- æ™ºèƒ½è¿ç§»å°å…ƒç´ ï¼ˆå¦‚"ä¸“ä¸šæŠ€èƒ½"çš„å•ä¸ªå°é¡¹ï¼‰
- ä¸ç ´åå†…å®¹è¯­ä¹‰
- æ¯é¡µéƒ½æ›´å¡«æ»¡

**ä¼˜ç‚¹ï¼š**
- ç²¾ç»†åŒ–æ§åˆ¶
- ä¸å‹ç¼©æ ·å¼
- è§†è§‰æ•ˆæœè‡ªç„¶

**ç¼ºç‚¹ï¼š**
- å®ç°å¤æ‚
- å¯èƒ½ç ´åæ¿å—å®Œæ•´æ€§
- éš¾ä»¥è°ƒè¯•

---

### æ–¹æ¡ˆ7ï¼šæ··åˆç­–ç•¥ï¼ˆç»ˆææ–¹æ¡ˆâ­â­â­â­â­ï¼‰

**éš¾åº¦ï¼š** â­â­â­â­â­ å¾ˆéš¾
**æ—¶é—´ï¼š** 60åˆ†é’Ÿ
**æ•ˆæœï¼š** â­â­â­â­â­

**åŸç†ï¼š** ç»„åˆå¤šç§æ–¹æ³•ï¼Œä¸¤é˜¶æ®µä¼˜åŒ–

**å®ç°ï¼š**
```javascript
function calculatePagesHybrid() {
  // ç¬¬1é˜¶æ®µï¼šç²—è°ƒï¼ˆä½¿ç”¨æ–¹æ¡ˆBï¼‰
  let { pages, heights } = findBestWithDynamicTolerance()

  // ç¬¬2é˜¶æ®µï¼šç²¾è°ƒ
  for (let i = 1; i < pages.length; i++) {
    const margin = MAX_CONTENT_HEIGHT - heights[i]

    if (margin > 300) {
      // å°è¯•æ–¹æ¡ˆ2ï¼šå‹ç¼©è¡Œé«˜
      const compressed = compressLineHeight(pages[i], margin - 200)

      if (compressed < 50) {
        // å‹ç¼©æ•ˆæœä¸æ˜æ˜¾ï¼Œå°è¯•æ–¹æ¡ˆ6ï¼šå…ƒç´ è¿ç§»
        const migrated = migrateFromNextPage(pages, i, margin - 200)

        if (migrated < 50) {
          // è¿ç§»æ•ˆæœä¹Ÿä¸æ˜æ˜¾ï¼Œå°è¯•æ–¹æ¡ˆ3ï¼šå·å…ƒç´ 
          stealFromNextPage(pages, i)
        }
      }
    }
  }

  return pages
}
```

**ä¼˜ç‚¹ï¼š**
- ç»“åˆå¤šç§æ–¹æ³•çš„ä¼˜åŠ¿
- çµæ´»æ€§æœ€é«˜
- æ•ˆæœæœ€å¥½

**ç¼ºç‚¹ï¼š**
- å¤æ‚åº¦æé«˜
- éš¾ä»¥ç»´æŠ¤
- è°ƒè¯•å›°éš¾

---

## ğŸ“‹ å››ã€ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | éš¾åº¦ | æ—¶é—´ | æ•ˆæœ | é£é™© | æ¨èæŒ‡æ•° | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|------|----------|----------|
| **æ–¹æ¡ˆ1ï¼šå¤šçº§å®½æ¾** | â­ | 5åˆ†é’Ÿ | â­â­â­ | ä½ | â­â­â­â­â­ | å¿«é€Ÿæ”¹è¿› |
| **æ–¹æ¡ˆ2ï¼šå‹ç¼©è¡Œé«˜** | â­â­â­ | 20åˆ†é’Ÿ | â­â­â­â­ | ä¸­ | â­â­â­â­ | è¿½æ±‚ç»†èŠ‚ |
| **æ–¹æ¡ˆ3ï¼šé€é¡µä¼˜åŒ–** | â­â­â­â­ | 30åˆ†é’Ÿ | â­â­â­â­â­ | é«˜ | â­â­â­â­ | æ ¹æ²»é—®é¢˜ |
| **æ–¹æ¡ˆ4ï¼šäºŒåˆ†æœç´¢** | â­â­ | 10åˆ†é’Ÿ | â­â­ | ä½ | â­â­â­ | æ€§èƒ½ä¼˜åŒ– |
| **æ–¹æ¡ˆ5ï¼šç”¨æˆ·å¯é€‰** | â­â­ | 15åˆ†é’Ÿ | â­â­â­ | ä½ | â­â­â­â­ | å¢å¼ºçµæ´»æ€§ |
| **æ–¹æ¡ˆ6ï¼šå…ƒç´ è¿ç§»** | â­â­â­â­ | 40åˆ†é’Ÿ | â­â­â­â­ | é«˜ | â­â­â­ | é«˜çº§ä¼˜åŒ– |
| **æ–¹æ¡ˆ7ï¼šæ··åˆç­–ç•¥** | â­â­â­â­â­ | 60åˆ†é’Ÿ | â­â­â­â­â­ | æé«˜ | â­â­â­ | ç»ˆææ–¹æ¡ˆ |

---

## ğŸ¯ äº”ã€æ¨èå®æ–½è·¯å¾„

### è·¯å¾„Aï¼šæ¸è¿›å¼ä¼˜åŒ–ï¼ˆä¿å®ˆï¼‰

```
å½“å‰ï¼ˆæ–¹æ¡ˆBï¼‰â†’ æ–¹æ¡ˆ1ï¼ˆå¤šçº§å®½æ¾ï¼‰â†’ æ–¹æ¡ˆ2ï¼ˆå‹ç¼©è¡Œé«˜ï¼‰â†’ æ–¹æ¡ˆ5ï¼ˆç”¨æˆ·å¯é€‰ï¼‰
```

**ä¼˜ç‚¹ï¼š** æ¯æ­¥é£é™©ä½ï¼Œå¯éšæ—¶åœæ­¢
**é€‚åˆï¼š** è¿½æ±‚ç¨³å®šçš„é¡¹ç›®

---

### è·¯å¾„Bï¼šæ¿€è¿›å¼ä¼˜åŒ–ï¼ˆå½»åº•ï¼‰

```
å½“å‰ï¼ˆæ–¹æ¡ˆBï¼‰â†’ æ–¹æ¡ˆ3ï¼ˆé€é¡µä¼˜åŒ–ï¼‰â†’ æ–¹æ¡ˆ2ï¼ˆå‹ç¼©è¡Œé«˜ï¼‰
```

**ä¼˜ç‚¹ï¼š** ä¸€æ¬¡æ€§è§£å†³é—®é¢˜
**é€‚åˆï¼š** æœ‰å……è¶³å¼€å‘æ—¶é—´

---

### è·¯å¾„Cï¼šæ€§èƒ½ä¼˜å…ˆï¼ˆå¿«é€Ÿï¼‰

```
å½“å‰ï¼ˆæ–¹æ¡ˆBï¼‰â†’ æ–¹æ¡ˆ4ï¼ˆäºŒåˆ†æœç´¢ï¼‰â†’ æ–¹æ¡ˆ5ï¼ˆç”¨æˆ·å¯é€‰ï¼‰
```

**ä¼˜ç‚¹ï¼š** ç«‹å³æå‡æ€§èƒ½
**é€‚åˆï¼š** å¤§ç®€å†ï¼ˆ>100é¡¹å†…å®¹ï¼‰

---

## ğŸ“ å…­ã€æŠ€æœ¯å€ºåŠ¡ä¸æœªæ¥å±•æœ›

### å½“å‰æŠ€æœ¯å€ºåŠ¡

1. **é«˜åº¦æµ‹é‡è¯¯å·®**ï¼ˆ2-3pxï¼‰
   - éœ€è¦æ›´ç²¾ç¡®çš„æµ‹é‡æ–¹æ³•
   - å¯èƒ½éœ€è¦å®é™…DOMæ¸²æŸ“éªŒè¯

2. **MarginæŠ˜å æœªè€ƒè™‘**
   - å½“å‰ç®€å•ç›¸åŠ marginTopå’ŒmarginBottom
   - å®é™…æ¸²æŸ“æ—¶ä¼šæŠ˜å 

3. **æš´åŠ›æœç´¢æ€§èƒ½**
   - è™½ç„¶å½“å‰å¯æ¥å—ï¼Œä½†ä¸æ˜¯æœ€ä¼˜è§£
   - å¯ä»¥ç”¨äºŒåˆ†æœç´¢ä¼˜åŒ–

4. **æœ€åä¸€é¡µç•™ç™½é—®é¢˜**
   - æ— æ³•å®Œå…¨é¿å…
   - éœ€è¦æ›´æ™ºèƒ½çš„å†…å®¹é‡ç»„

---

### æœªæ¥å±•æœ›

**çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰ï¼š**
- å®æ–½æ–¹æ¡ˆ1ï¼ˆå¤šçº§å®½æ¾ï¼‰
- ä¼˜åŒ–è¯„åˆ†æƒé‡å‚æ•°

**ä¸­æœŸï¼ˆ1-2æœˆï¼‰ï¼š**
- å®æ–½æ–¹æ¡ˆ2ï¼ˆå‹ç¼©è¡Œé«˜ï¼‰
- æ·»åŠ æ–¹æ¡ˆ5ï¼ˆç”¨æˆ·å¯é€‰ï¼‰

**é•¿æœŸï¼ˆ3-6æœˆï¼‰ï¼š**
- æ¢ç´¢æ–¹æ¡ˆ3ï¼ˆé€é¡µä¼˜åŒ–ï¼‰
- è€ƒè™‘æ–¹æ¡ˆ7ï¼ˆæ··åˆç­–ç•¥ï¼‰

---

## ğŸ”§ ä¸ƒã€è°ƒè¯•ä¸ç›‘æ§

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**
   ```
   ğŸ” å¼€å§‹æµ‹è¯•ä¸åŒ safetyBuffer å€¼...
   ğŸ“Š åˆæµ‹ç»“æœ
   ğŸ¯ ç­–ç•¥é€‰æ‹©
   âœ… æœ€ç»ˆæ–¹æ¡ˆ
   ```

2. **ä¿®æ”¹å‚æ•°æµ‹è¯•**
   ```javascript
   // è°ƒæ•´é˜ˆå€¼
   if (initialMargins[1] > 150) // æ”¹ä¸º 120, 200, etc.

   // è°ƒæ•´ç›®æ ‡
   dynamicTarget = 45 // æ”¹ä¸º 30, 60, etc.

   // è°ƒæ•´å®¹å·®
   dynamicTolerance = 15 // æ”¹ä¸º 10, 20, etc.
   ```

3. **å¯¹æ¯”ä¸åŒsafetyBufferçš„æ•ˆæœ**
   ```javascript
   // ä¿®æ”¹testBuffersï¼Œåªä¿ç•™å‡ ä¸ªå…³é”®å€¼
   const testBuffers = [0, 0.5, 1, 2]
   ```

---

### æ€§èƒ½ç›‘æ§

**å…³é”®æŒ‡æ ‡ï¼š**
- åˆ†é¡µè®¡ç®—æ—¶é—´ï¼ˆç›®æ ‡<100msï¼‰
- å†…å­˜å ç”¨ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºDOMï¼‰
- ç”¨æˆ·ä½“éªŒï¼ˆæ˜¯å¦æœ‰å¡é¡¿ï¼‰

**ç›‘æ§æ–¹æ³•ï¼š**
```javascript
console.time('åˆ†é¡µè®¡ç®—')
await calculatePages()
console.timeEnd('åˆ†é¡µè®¡ç®—')
```

---

## ğŸ“š å…«ã€å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡æ¡£
- `doc/åˆ†é¡µç®—æ³•é—®é¢˜åˆ†æ.md` - æ—©æœŸé—®é¢˜åˆ†æ
- `doc/åˆ†é¡µé—®é¢˜.md` - åˆå§‹é—®é¢˜è®°å½•
- `src/components/Preview.vue` - æ ¸å¿ƒå®ç°ä»£ç 

### å…³é”®ä»£ç ä½ç½®
- åˆ†é¡µç®—æ³•ï¼š`src/components/Preview.vue:123-197`
- æ–¹æ¡ˆBå®ç°ï¼š`src/components/Preview.vue:200-306`
- å¸¸é‡å®šä¹‰ï¼š`src/components/Preview.vue:64-69`

---

**æ–‡æ¡£ç»“æŸ**

*æœ€åæ›´æ–°ï¼š2026-01-25*
*ç»´æŠ¤è€…ï¼šClaude Code*
*ç‰ˆæœ¬ï¼šv1.0*
